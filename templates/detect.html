<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Detection | Janadhvani</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

<nav class="navbar">
  <!-- Back to Home -->
  <a href="/" class="logo">
    <i class="fa-solid fa-arrow-left"></i>
    <span>Home</span>
  </a>

  <!-- Page Title -->
  <h3>
    <i class="fa-solid fa-satellite-dish"></i>
    Live Road Analyzer
  </h3>

  <!-- Generate Report -->
  <a href="/report" class="btn"
     style="background: var(--dark); border: 1px solid var(--primary);">
    <i class="fa-solid fa-file-lines"></i>
    Generate Report
  </a>
</nav>


<div class="dashboard-container">
  
  <!-- Left Side: Camera Feed -->
  <div class="cam-wrapper animate-entry">
    <video id="video" autoplay playsinline></video>
    <img id="captured-preview" 
     style="display:none; width:100%; margin-top:10px; border-radius:10px; border:1px solid #334155;">

    <div class="scanner-line"></div>
    <div class="overlay-text">AI ACTIVE</div>
    <canvas id="canvas" hidden></canvas>
  </div>

  <!-- Right Side: Controls & Map -->
  <div class="sidebar">
    
    <div class="info-panel animate-entry delay-1">
      <h4><i class="fa-solid fa-circle-info"></i> Detection Status</h4>
      <p id="status-text" style="color: #94a3b8; margin-top: 10px;">System Ready. Waiting for input...</p>
      <div id="stats" style="margin-top: 15px; font-family: monospace;">
        <div>GPS: <span id="gps-status" style="color: var(--accent)">Locating...</span></div>
        <div>FPS: <span id="fps-count">--</span></div>
      </div>
    </div>

    <div class="info-panel animate-entry delay-2">
      <h4><i class="fa-solid fa-map"></i> Incident Map</h4>
      <div id="map"></div>
    </div>

    <button onclick="capture()" class="capture-btn animate-entry delay-3">
      <i class="fa-solid fa-camera-shutter"></i> Analyze Road Surface
    </button>
  </div>

</div>

<script>
let lat = null, lon = null;
let userMarker = null;
let potholeMarkers = [];
let mapInitialized = false;

const statusText = document.getElementById("status-text");
const gpsStatus = document.getElementById("gps-status");
const video = document.getElementById("video");

// ---------- MAP INIT ----------
const map = L.map("map").setView([20.5937, 78.9629], 5);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
  attribution: "&copy; OpenStreetMap contributors &copy; CARTO"
}).addTo(map);

// ---------- REQUEST LOCATION ----------
function requestLocation() {
  navigator.geolocation.getCurrentPosition(
    pos => {
      lat = pos.coords.latitude;
      lon = pos.coords.longitude;

      gpsStatus.innerText = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
      gpsStatus.style.color = "#4ade80";

      if (!mapInitialized) {
        map.setView([lat, lon], 16);
        userMarker = L.marker([lat, lon])
          .addTo(map)
          .bindPopup("Current Location")
          .openPopup();
        mapInitialized = true;
      } else {
        userMarker.setLatLng([lat, lon]);
      }
    },
    () => gpsStatus.innerText = "Permission Denied",
    { enableHighAccuracy: true }
  );
}

// ---------- CAMERA ----------
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" }
})
.then(stream => video.srcObject = stream)
.catch(() => statusText.innerText = "Camera permission denied");

// ---------- CAPTURE ----------
function capture() {
  if (lat === null || lon === null) {
    statusText.innerText = "Waiting for GPS permission...";
    return;
  }

  const canvas = document.getElementById("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  document.getElementById("captured-preview").src =
    canvas.toDataURL("image/jpeg");
  document.getElementById("captured-preview").style.display = "block";

  statusText.innerText = "ðŸ“¡ Analyzing image using YOLO model...";

  canvas.toBlob(blob => {
    const data = new FormData();
    data.append("image", blob);
    data.append("latitude", lat);
    data.append("longitude", lon);

    fetch("/detect", { method: "POST", body: data })
      .then(r => r.json())
      .then(d => {
        console.log("API RESPONSE:", d);

        document.getElementById("fps-count").innerText = d.fps || "API";

        if (d.count === 0) {
          statusText.innerText = "âœ… Analysis complete | No potholes detected";
        } else {
          statusText.innerText =
            `âš ï¸ Detected ${d.count} pothole(s) on this road`;
        }

        loadPotholes();
      })
      .catch(err => {
        console.error(err);
        statusText.innerText = "âŒ AI analysis failed";
      });
  });
}

// ---------- LOAD POTHOLES ----------
function loadPotholes() {
  // Clear old markers
  potholeMarkers.forEach(m => map.removeLayer(m));
  potholeMarkers = [];

  fetch("/api/potholes")
    .then(r => r.json())
    .then(data => {
      data.forEach(p => {
        const color =
          p.severity === "High" ? "red" :
          p.severity === "Medium" ? "orange" : "green";

        const marker = L.circleMarker([p.lat, p.lon], {
          radius: 8,
          color: color,
          fillOpacity: 0.9
        })
        .addTo(map)
        .bindPopup(`Severity: ${p.severity}`);

        potholeMarkers.push(marker);
      });
    });
}

// ---------- ON LOAD ----------
requestLocation();
loadPotholes();
</script>


</body>
</html>